package test

import (
	"crypto/rand"
	"encoding/base64"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"github.com/gogf/gf/util/grand"
	"github.com/golang/protobuf/proto"
	"io"
	"strconv"
	"strings"
	"testing"
	"ws-go/libsignal/kdf"
	"ws-go/protocol/register"
	"ws-go/protocol/utils"
	"ws-go/protocol/waproto"
)

func TestProto(t *testing.T) {
	c, _ := hex.DecodeString("09c2ffd8ffe000104a46494600010100000100010000ffed008450686f746f73686f7020332e30003842494d04040000000000681c0228006246424d443061303030613664303130303030323030323030303031333033303030303366303330303030373930333030303034373034303030306565303530303030333330363030303037303036303030306236303630303030633230393030303000ffdb00430006040506050406060506070706080a100a0a09090a140e0f0c1017141818171416161a1d251f1a1b231c1616202c20232627292a29191f2d302d283025282928ffdb0043010707070a080a130a0a13281a161a2828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828282828ffc20011080060006003012200021101031101ffc4001b00000202030100000000000000000000000203000104050607ffc40017010101010100000000000000000000000000020103ffda000c03010002100310000001e9e9ca8d2b90825408588984bcd20ad133aeb09aa86058aaf3484858bb2c530bcfb334f71eca41736cb5596968e681a0c9c46df87a85aa1d47b208b79f558b14dbb50b723579bc3eceb758c5df2be9f57dccd6d80a65952e114dc434dc765ea2a2391d79b4d8c91d33eaab72c6d45f21b8e1b6549a2a8cfed313691d5999879195ffc400221000010304020301010000000000000000010003110204103112210513413214ffda0008010100010502fa81944e0a2538254e2ac10884352b58f8aa8a8890b6bc95d7aa9051ef12a707b5ac4abe785bb4ed649073552b4815b52a13ce0a1bba7cbd593818955690242daaba5e46e7dd5d6650da0a78ad8442ec205794b9e34b9562912631fa53c4f252b6af1dfe76de709477f3c65b40c42328853d72029beb8f73b5992ac58f7b94885d15d85cbada3d63c93dc53d5ce1ba2a72bb767d0d8532bf38da90ae1c0d34fb864ad0f14c71a469420713234bc8dc7b1caea92159305f76910a92a9d4afb2aa57f71c1a76ac77368c7a1aa7b415257fffc40017110101010100000000000000000000000001201000ffda0008010301013f0195a59597021e217033ffc40017110101010100000000000000000000000001203010ffda0008010201013f01cc92d7379fffc4002910000005020503040300000000000000000001021021113112132032614142512230339181a1c1ffda0008010100063f026a8e5bc18a2a04109d123c90a8914e82adc68cb47c877e344b40f06dc8a2862ba8f683528eaa3d32f2c6a5d886357e0b47224488781853f1a7f7ec40911f432907ea3bf028d84a4cfd8357d103354a8df39573b0979969b0ad601abb4a12f556c48812f221b293d6e284c484dcc1252d238102194b3e80d4adca7cd56e3b3c340f06d84b621e9da57142791fd143bb50b728509a8408bbba8f53ff00ffc400261000020202020201040301000000000000000111213151416171819110a1c1f0b1d1e1f1ffda0008010100013f21ce15a2270dcae1f04cdba38b022ecbbcc9a307b822183a22aa37cff66169b212b8261af9838127b47ea58b32479e5106e96351e4161e486e24ed314ac5846a2a1684ed9d89a4873289fc0db53919457b1aba731f22f325d0a187e876e3fec7903f9f28694a49c3647fab2595809cbff07b2bedb10ea30636e450d46443545e86479b9d109afc8e0ea885b6335854b1f64855a11311235f62c4cc6c49d53b1bf00fb25d32921431d1724ba345cb1f79b1ed9a1242af6611cb2546a49fa13ac131d9195d9b9ec70ebbe84b4b8c0ec62ed70346e54263ccac21bc26c4dd05b193453d8f871d89e41d6c6387b2dbfa0ea43549d17c2d92d523f274348b2051014560926f920b0793478273f24f31152dd7dbd0a0963739e09ec441c9a26128552c4eaa73d8c49dcacdf084370177620d97409b3256e365a07557ca2f2b0d57242724f32ce67c8d821252db1b6964b1a55e49e427d3a1d0b92b2d398a43d10ff92c697c0dc5fba1a720370b592c96fef32799c8a9b943aa3ae087298ab0c89e23d068124c1e4339ac12d7d4968897cc2ba5424c8896ea8458ceda08b48afd3fffda000c030100020003000000105d24e9acb3a75af9fcd61a6f7bdaf3f18f6feb344ce3c628701db8ffc4001a110003010101010000000000000000000000011011214120ffda0008010301013f108a2661da95db952199722146c433d3e1f58ba246cf21194fffc400191101000301010000000000000000000000010010112120ffda0008010201013f10bda0db5b19162d1079209395e40c8b91ecd8b03696d7ffc40024100100020202030002030101000000000001001121314151617181a1d191b1c1e1f0ffda0008010100013f10c3080ed163e460037b2299f48ce1ba55ff0044876355c95a66ea556e8c2c058d314f2f17cc0bdc67a2452a21b1555ea6da11b7e412c26d5e1d89d44ea5675cbe6345a36b58cb390de1fe676d964a6bf94c0160c5ebc092c3c62cc3f6210399ecfdca28c6583b259862e2b4711f15b29c9fb8f8c562f084d25298187d4df84b9730953c22ed37e1495585279dc166cf0e63d3c00b43d3cfd95bab34e57e605f1ab859fcfee714394b80a74e29e65b2c1b269388a6aeb17f84e61da217a6ecf222aa1995939bf0ee259154cff303b201a485e46475922a44066a58017db152b24d9ffb314962cde87c8975c8e530682f0eb3107859b770b4b09c9e0ede221c2e564e308c68fcf12814a39de2294aae14d8c5696070dfbee50d3d534c4c06396c7f4ca53c8e5dfa61e5c0d3b3d4159c179751537baecffb2e6f1ca34773c1c4741815315897d75e6f889c2acb0378995ade0c91206be9312f60d9cc17575df4c14792c9858e85b6034f9d440bcd5ab3f194a731ad2ecf0b00181f0420598c5e39a87aa4e2655d129650ac69f92e2bf452c0586d8aaa0f93201caaef0fc995a275bc41e2a74737eba803607a47862af91fec6da854e6273336e17994a021c5f708cd4d3cd19f661bb1cad91407b17f209a9b748eba9a24734ecf92a01b45b8a4f5310583d0438a455e29cdc751a64b8bff00a9c335c9afb3532539f9171c22dd518814d4400ad1e262809488ec9cb9770b08a6cbd4a3dde91c9e206f65bd5d7ea676956031f84f1820bc7f659d438a3fdf33210a8c0461149c60f7e2731591b5b662178b01213190d362fa4e2598671bebdcaeeaf2dce26a45e9b3fb3fd973301c6973c75827803ec0e0a177f08a961d94e3d442ecaeaa3f012d84ff00b8a1b95d53c12eb4bb9abfe62889265bc90c825985f11ae0d6f45c7895347fb3797478f6cc8dbdde39df91d85793a21b6c80f882f19595d71ed89025c17c7a88abf008f6e3d6080d5948c89fb9854b61e4faf5002974e9f51d6366f2417542f6c72c0c055de56af7703b16e5d4552f001cac0b5b872daee24ee0c3fb86cae7a6594065c2cfffd9")
	t.Log(string(c))
	ps := waproto.VerifiedName{}
	err := proto.Unmarshal(c[4:], &ps)
	if err != nil {
		t.Fatal(err)
	}
	fmt.Println("ok")

	/*c, _ := base64.StdEncoding.DecodeString("ChkI4pHmu6Tw0/gcEgZzbWI6d2EiBWhha2FuEkBtS/8BoKScy/l5336gf/q/mK0Fw1yRokm+O+S3POMjTQkkUq6X+/vPIdbHZOBoTwm0FAY1bIQlcPfKvQr5/RoA")
	ps:=waproto.VerifiedName{}
	err := proto.Unmarshal(c, &ps)
	if err != nil {
		t.Fatal(err)
	}*/
}

func TestMediaupload(t *testing.T) {
	// 随机生成 32 位秘钥然后进行秘钥扩展
	randomKeys := grand.B(32)
	kdf.DeriveSecrets(randomKeys, nil, []byte("WhatsApp Image Keys"), 80)
}
func TestBackToken(t *testing.T) {
	//a0417729-1c4a-4999-b63d-bb5f9aafa8a8
	//0ec73292-f94e-4de4-b725-6c060d88d976
	//base64Str := "RFObk0NHtvEmCSluaRRbWDCd+U7QqKWi2UB4qOr/hwE+PZWmlkSqG5JGRlMsJ5+LzShVq1XyyLwWk623gAyI/w=="
	hmacKey, _ := hex.DecodeString("30820332308202F0A00302010202044C2536A4300B06072A8648CE3804030500307C310B3009060355040613025553311330110603550408130A43616C69666F726E6961311430120603550407130B53616E746120436C61726131163014060355040A130D576861747341707020496E632E31143012060355040B130B456E67696E656572696E67311430120603550403130B427269616E204163746F6E301E170D3130303632353233303731365A170D3434303231353233303731365A307C310B3009060355040613025553311330110603550408130A43616C69666F726E6961311430120603550407130B53616E746120436C61726131163014060355040A130D576861747341707020496E632E31143012060355040B130B456E67696E656572696E67311430120603550403130B427269616E204163746F6E308201B83082012C06072A8648CE3804013082011F02818100FD7F53811D75122952DF4A9C2EECE4E7F611B7523CEF4400C31E3F80B6512669455D402251FB593D8D58FABFC5F5BA30F6CB9B556CD7813B801D346FF26660B76B9950A5A49F9FE8047B1022C24FBBA9D7FEB7C61BF83B57E7C6A8A6150F04FB83F6D3C51EC3023554135A169132F675F3AE2B61D72AEFF22203199DD14801C70215009760508F15230BCCB292B982A2EB840BF0581CF502818100F7E1A085D69B3DDECBBCAB5C36B857B97994AFBBFA3AEA82F9574C0B3D0782675159578EBAD4594FE67107108180B449167123E84C281613B7CF09328CC8A6E13C167A8B547C8D28E0A3AE1E2BB3A675916EA37F0BFA213562F1FB627A01243BCCA4F1BEA8519089A883DFE15AE59F06928B665E807B552564014C3BFECF492A0381850002818100D1198B4B81687BCF246D41A8A725F0A989A51BCE326E84C828E1F556648BD71DA487054D6DE70FFF4B49432B6862AA48FC2A93161B2C15A2FF5E671672DFB576E9D12AAFF7369B9A99D04FB29D2BBBB2A503EE41B1FF37887064F41FE2805609063500A8E547349282D15981CDB58A08BEDE51DD7E9867295B3DFB45FFC6B259300B06072A8648CE3804030500032F00302C021400A602A7477ACF841077237BE090DF436582CA2F0214350CE0268D07E71E55774AB4EACD4D071CD1EFAD")
	basDec := base64.StdEncoding.EncodeToString(hmacKey)
	fmt.Println(basDec)
}

//验证通过
func TestGetToken(t *testing.T) {
	//vyfeDt1SjCdI1Jp51Qh0ajNKTko
	vs := "MIIDMjCCAvCgAwIBAgIETCU2pDALBgcqhkjOOAQDBQAwfDELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFDASBgNVBAcTC1NhbnRhIENsYXJhMRYwFAYDVQQKEw1XaGF0c0FwcCBJbmMuMRQwEgYDVQQLEwtFbmdpbmVlcmluZzEUMBIGA1UEAxMLQnJpYW4gQWN0b24wHhcNMTAwNjI1MjMwNzE2WhcNNDQwMjE1MjMwNzE2WjB8MQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEUMBIGA1UEBxMLU2FudGEgQ2xhcmExFjAUBgNVBAoTDVdoYXRzQXBwIEluYy4xFDASBgNVBAsTC0VuZ2luZWVyaW5nMRQwEgYDVQQDEwtCcmlhbiBBY3RvbjCCAbgwggEsBgcqhkjOOAQBMIIBHwKBgQD9f1OBHXUSKVLfSpwu7OTn9hG3UjzvRADDHj+AtlEmaUVdQCJR+1k9jVj6v8X1ujD2y5tVbNeBO4AdNG/yZmC3a5lQpaSfn+gEexAiwk+7qdf+t8Yb+DtX58aophUPBPuD9tPFHsMCNVQTWhaRMvZ1864rYdcq7/IiAxmd0UgBxwIVAJdgUI8VIwvMspK5gqLrhAvwWBz1AoGBAPfhoIXWmz3ey7yrXDa4V7l5lK+7+jrqgvlXTAs9B4JnUVlXjrrUWU/mcQcQgYC0SRZxI+hMKBYTt88JMozIpuE8FnqLVHyNKOCjrh4rs6Z1kW6jfwv6ITVi8ftiegEkO8yk8b6oUZCJqIPf4VrlnwaSi2ZegHtVJWQBTDv+z0kqA4GFAAKBgQDRGYtLgWh7zyRtQainJfCpiaUbzjJuhMgo4fVWZIvXHaSHBU1t5w//S0lDK2hiqkj8KpMWGywVov9eZxZy37V26dEqr/c2m5qZ0E+ynSu7sqUD7kGx/zeIcGT0H+KAVgkGNQCo5Uc0koLRWYHNtYoIvt5R3X6YZylbPftF/8ayWTALBgcqhkjOOAQDBQADLwAwLAIUAKYCp0d6z4QQdyN74JDfQ2WCyi8CFDUM4CaNB+ceVXdKtOrNTQcc0e+t"
	key := "RFObk0NHtvEmCSluaRRbWDCd+U7QqKWi2UB4qOr/hwE+PZWmlkSqG5JGRlMsJ5+LzShVq1XyyLwWk623gAyI/w=="
	token, err := register.TestToken("658027827", key, "FvBkNweJGf4WVuHWSU793g==", vs)
	if err != nil {
		t.Fatal(err)
	}
	fmt.Println(token)
}

func TestVal(t *testing.T) {
	v := "fc0fe99d9ee59586e4b89ae5b890e688b7"
	bytes := []byte(v)
	var resp map[string]interface{}
	_ = json.Unmarshal(bytes, &resp)
	fmt.Println(string(bytes))
}

func TestDec(t *testing.T) {
	v := "fc0fe99d9ee59586e4b89ae5b890e688b7"
	decode, _ := hex.DecodeString(v)
	ps := waproto.Message{}
	err := proto.Unmarshal(decode, &ps)
	if err != nil {
		t.Fatal(err)
	}

	str := "MwiCuL6gBxA2GiD3DzZUQp1AL5AGDFFz/Lpx1nSzzmNJu3hOpXp0HLJrkPBG9PJRVK7a/81nVZzNmNrwh/Y+62oggIrHP63vvhnm21Y7GW50EiEukV3/9ezuTkTTCftY1SIlH7UaLCxn7gs="
	baseData, err := base64.StdEncoding.DecodeString(str)
	if err != nil {
		t.Fatal(err)
	}
	fmt.Println(baseData)
	/*	err = proto.Unmarshal(baseData, &clientPayload)
		if err != nil {
			t.Fatal(err)
		}*/
}

func TestEnc(t *testing.T) {
	/*<category id="644728732639272">fc0fe99d9ee59586e4b89ae5b890e688b7</category>
	<category id="1223524174334504">fc0ce6b1bde8bda6e69c8de58aa1</category>
	<category id="1086422341396773">fc06e69c8de8a385</category>
	<category id="133436743388217">fc0fe69687e889bae4b88ee5a8b1e4b990</category>
	<category id="139225689474222">fc1ee7be8ee5aeb9e38081e7be8ee5a686e4b88ee4b8aae4babae68aa4e79086</category>
	<category id="2250">fc06e69599e882b2</category>
	<category id="193705277324704">fc0fe6b4bbe58aa8e7ad96e58892e4baba</category>
	<category id="1022050661163852">fc06e98791e89e8d</category>
	<category id="150108431712141">fc06e8b685e5b882</category>
	<category id="164243073639257">fc06e98592e5ba97</category>
	<category id="145118935550090">fc0fe58cbbe79697e4b88ee581a5e5bab7</category>
	<category id="2603">fc0fe99d9ee890a5e588a9e7bb84e7bb87</category>
	<category id="273819889375819">fc06e9a490e9a686</category>
	<category id="200600219953504">fc0ce99bb6e594aee8b4ade789a9</category>
	<category id="128232937246338">fc0fe69785e8a18ce4b88ee4baa4e9809a</category>*/
	v := "fc0fe69785e8a18ce4b88ee4baa4e9809a"
	decode, _ := hex.DecodeString(v)
	fmt.Println(string(decode[2:]))
}

func TestBase64(t *testing.T) {
	var random [64]byte
	r := rand.Reader
	io.ReadFull(r, random[:])
	fmt.Println(len(random))
	randVal := "288328b37a92b29f3b5e3160385416b405367c494feb9ee2c555de9a86e11cc19cfb8b9ca33c1f9f3cb9c4ce8bf99b81636ee9497ba068d73698cdb5682d704c"
	v1 := strings.ReplaceAll(randVal, "b5682d704c", utils.MakeYearDaysRand(10))
	fmt.Println(v1)
	randId, _ := strconv.ParseUint(utils.MakeYearDaysRand(19), 0, 64)
	fmt.Println(randId)
	v := waproto.VerifiedName{
		VerifiedOne: &waproto.VerifiedName_VerifiedOne{
			VerifiedOne1: proto.Uint64(randId),
			VerifiedOne2: proto.String("smb:wa"),
			VerifiedOne4: proto.String(""),
		},
		VerifiedTow: nil,
	}
	bstr, _ := proto.Marshal(&v)
	fmt.Println(bstr)
}
